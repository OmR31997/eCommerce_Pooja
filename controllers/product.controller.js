import { Vendor } from '../models/vendor.model.js';
import { Category } from '../models/category.model.js';
import { Product } from '../models/product.model.js';

/* **create_product logic here** */
export const create_product = async (req, res) => {
    try {
        const { sku, categorySlug } = req.body;
        const vendorId = req.user.id;

        if (sku) {
            return res.status(400).json({
                error: `Please do not include 'sku' field — it is auto-generated by the system.`,
                success: false,
            });
        }

        if (!categorySlug) {
            return res.status(400).json({
                error: `'categorySlug' field must be required`,
                success: false,
            });
        }

        const category = await Category.findOne({ slug: categorySlug }).select('_id name');

        if (!category) {
            return res.status(404).json({
                error: 'Category not found',
                success: false,
            });
        }

        const default_sku = `SKU-${Date.now()}-${Math.floor(Math.random() * 1000)}`;

        const responseProduct = await Product.create({
            ...req.body,
            vendorId,
            categoryId: category._id,
            sku: default_sku,
        });

        return res.status(201).json({
            message: 'Product created successfully',
            data: {
                ...responseProduct._doc,
                categoryName: category.name,
            },
            success: true,
        });

    } catch (error) {
        if (error.name === 'ValidationError') {
            const errors = {};

            Object.keys(error.errors).forEach(key => {
                errors[key] = error.errors[key].message;
            });

            return res.status(400).json({
                errors,
                message: 'Validation failed',
                success: false,
            });
        }

        return res.status(500).json({
            error: error.message,
            message: 'Internal Server Error',
            success: false,
        });
    }
}

/* **view_products logic here** */
export const view_products = async (req, res) => {
    try {
        const products = await Product.find({ status: 'approved' })
            .populate({ path: 'vendorId', select: 'shopName -_id' })
            .populate('categoryId', 'name slug -_id')
            .select('-vendorId -categoryId');

        if (products.length === 0) {
            return res.status(404).json({
                error: 'Product not found',
                success: false,
            });
        }

        return res.status(200).json({
            data: products,
            success: true,
        });
    } catch (error) {
        return res.status(500).json({
            error: error.message,
            message: 'Internal Server Error',
            success: false,
        });
    }
}

/* **view_single_product logic here** */
export const view_single_product = async (req, res) => {
    try {
        const key = req.params.id;

        const filter = key.startsWith('SKU-') ? { sku: key } : { _id: key };
        filter.status = 'approved';

        const product = await Product.findOne(filter)
            .populate({ path: 'vendorId', select: 'shopName -_id' })
            .populate('categoryId', 'name slug -_id')
            .select('-vendorId -categoryId');

        if (!product) {
            return res.status(404).json({
                error: 'Product not found',
                success: false,
            });
        }

        return res.status(200).json({
            data: product,
            success: true,
        });

    } catch (error) {
        return res.status(500).json({
            error: error.message,
            message: 'Internal Server Error',
            success: false,
        });
    }
}

/* **view_vendor_products logic here** */
export const view_vendor_products = async (req, res) => {
    try {
        const vendorId = req.user.id;

        const products = await Product.find({ vendorId })
            .populate({ path: 'vendorId', select: 'shopName' })
            .populate('categoryId', 'name slug -_id')
            .select('-vendorId -categoryId');;

        if (products.length === 0) {
            return res.status(400).json({
                error: 'Product not found',
                success: false,
            });
        }

        return res.status(200).json({
            data: products,
            success: true,
        });

    } catch (error) {
        return res.status(500).json({
            error: error.message,
            message: 'Internal Server Error',
            success: false,
        });
    }
}

/* **view_vendor_product logic here** */
export const view_vendor_product = async (req, res) => {
    try {
        const vendorId = req.user.id;
        const productId = req.params.id;

        const products = await Product.find({ _id: productId, vendorId })
            .populate({ path: 'vendorId', select: 'shopName' })
            .populate('categoryId', 'name slug -_id')
            .select('-vendorId -categoryId');

        if (products.length === 0) {
            return res.status(400).json({
                error: 'Product not found',
                success: false,
            });
        }

        return res.status(200).json({
            data: products,
            success: true,
        });

    } catch (error) {
        return res.status(500).json({
            error: error.message,
            message: 'Internal Server Error',
            success: false,
        });
    }
}

/* **manage_product logic here** */
export const manage_product = async (req, res) => {
    try {
        const key = req.params.id;

        const filter = key.startsWith('SKU-') ? { sku: key } : { _id: key };
        const { _id, status, sku, vendorId, rating, slug, ...rest } = req.body;
        const { id, role } = req.user;

        if (rating) {
            return res.status(400).json({
                error: `You cannot manually update 'rating' fields.`,
                success: false,
            })
        }

        const product = await Product.findOne(filter);
        if (!product) {
            return res.status(404).json({
                error: 'Product not found',
                success: false,
            });
        }


        if (role === 'vendor') {

            if (status) {
                return res.status(400).json({
                    error: `You cannot update 'status' field — please talk with admin`,
                    success: false,
                });
            }

            if (sku) {
                return res.status(400).json({
                    error: `Please do not include 'sku' field — it is auto-generated by the system.`,
                    success: false,
                });
            }

            if (slug) {
                const category = await Category.findOne({ slug });

                if (!category) {
                    return res.status(404).json({
                        error: `Category with slug '${slug}' not found`,
                        success: false,
                    });
                }

                rest.categoryId = category._id;
            }

            if (vendorId || _id) {
                return res.status(400).json({
                    error: `You cannot modify protected fields like 'vendorId' or '_id'.`,
                    success: false,
                });
            }

            if (Object.keys(rest).length === 0) {
                return res.status(400).json({
                    error: 'No valid field to update',
                    success: false,
                })
            }

            if (product.vendorId.toString() !== id) {
                return res.status(403).json({
                    error: 'You are not authorized to modify this product.',
                    success: false,
                });
            }

            Object.assign(product, rest);

            const updateProduct = await product.save();

            return res.status(200).json({
                message: 'Product updated successfully',
                data: updateProduct,
                success: true,
            });
        }
        else if (role === 'admin') {

            const extraFields = Object.keys(rest);

            if (extraFields.length > 0) {
                return res.status(400).json({
                    error: `Admin can only update 'status' field. Found extra fields: ${extraFields.join(', ')} `
                })
            }

            if (!status) {
                return res.status(400).json({
                    error: `Please provide 'status' field (e.g., 'pending', 'approved', 'rejected', 'inactive')`,
                    success: false,
                });
            }

            product.status = status;

            const updateRespnse = await product.save();

            return res.status(200).json({
                message: 'Product status updated successfully',
                data: updateRespnse,
                success: true,
            });
        }
        else {
            return res.status(403).json({
                error: 'You are not authorized to perform this action.',
                success: false,
            });
        }

    } catch (error) {
        return res.status(500).json({
            error: error.message,
            message: 'Internal Server Error',
            success: false,
        });
    }
}

/* **rate_product logic here** */
export const rate_product = async (req, res) => {
    try {
        const { rating } = req.body;
        const productId = req.params.id;

        if (!rating || rating < 1 || rating > 5) {
            return res.status(400).json({
                error: `'rating' field is required and must be between 1 to 5 `,
                success: false,
            });
        }

        const product = await Product.findById(productId);

        if (!product) {
            return res.status(400).json({
                error: 'Product not found',
                success: false,
            });
        }

        const total = product.rating.totalReview;
        const avg = product.rating.average;

        const newTotal = total + 1;
        const newAvg = ((avg * total) + rating) / newTotal;

        product.rating.average = parseFloat(newAvg.toFixed(1));
        product.rating.totalReview = newTotal;

        const ratingResponse = await product.save();

        return res.status(200).json({
            message: 'Product rated successfully',
            data: ratingResponse,
            success: true,
        });

    } catch (error) {
        return res.status(500).json({
            error: error.message,
            message: 'Internal Server Error',
            success: false,
        });
    }
}